#!/bin/bash
# ==============================================================================
# –°–∫—Ä–∏–ø—Ç –ø–æ–≤–Ω–æ–≥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Python-—Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ —Ç–∞ Vim
# –ê–≤—Ç–æ—Ä: Wendors
# –í–µ—Ä—Å—ñ—è: 2.0
# ==============================================================================

set -e

# –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–∏–≤–æ–¥—É
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –∫–æ–ª—å–æ—Ä–æ–≤–æ–≥–æ –≤–∏–≤–æ–¥—É
error() { echo -e "${RED}‚ùå $1${NC}"; }
success() { echo -e "${GREEN}‚úÖ $1${NC}"; }
warning() { echo -e "${YELLOW}‚ö†Ô∏è $1${NC}"; }
info() { echo -e "${BLUE}üìù $1${NC}"; }
step() { echo -e "${BLUE}üöÄ $1${NC}"; }

# ==============================================================================
# –ü–û–ß–ê–¢–û–ö –°–ö–†–ò–ü–¢–ê
# ==============================================================================

echo "================================================================"
echo "üõ†Ô∏è  –ü–û–í–ù–ê –Ü–ù–°–¢–ê–õ–Ø–¶–Ü–Ø PYTHON –¢–ê VIM –°–ï–†–ï–î–û–í–ò–©–ê"
echo "================================================================"

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤
if [ "$EUID" -eq 0 ]; then
    error "–ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –ø—ñ–¥ root!"
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞
if ! command -v apt &> /dev/null; then
    error "–¶–µ–π —Å–∫—Ä–∏–ø—Ç –ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ –Ω–∞ Debian/Ubuntu"
    exit 1
fi

# ==============================================================================
# –ö–†–û–ö 1: –û–ù–û–í–õ–ï–ù–ù–Ø –°–ò–°–¢–ï–ú–ò
# ==============================================================================
step "–û–Ω–æ–≤–ª—é—î–º–æ —Å–∏—Å—Ç–µ–º—É —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –±–∞–∑–æ–≤—ñ –ø–∞–∫–µ—Ç–∏..."

sudo apt update
sudo apt upgrade -y

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–∏—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
sudo apt install -y \
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    git \
    curl \
    wget \
    build-essential \
    cmake \
    ncurses-dev \
    libgtk-3-dev \
    libatk1.0-dev \
    libcairo2-dev \
    libx11-dev \
    libxpm-dev \
    libxt-dev \
    ruby-dev \
    lua5.3 \
    liblua5.3-dev \
    libperl-dev \
    clang \
    nodejs \
    npm

success "–°–∏—Å—Ç–µ–º–Ω—ñ –ø–∞–∫–µ—Ç–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"

# ==============================================================================
# –ö–†–û–ö 2: –í–ò–ë–Ü–† –ú–ï–¢–û–î–£ –í–°–¢–ê–ù–û–í–õ–ï–ù–ù–Ø VIM
# ==============================================================================
echo ""
info "–û–±–µ—Ä—ñ—Ç—å —Å–ø–æ—Å—ñ–± –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Vim:"
echo "1) –®–≤–∏–¥–∫–∏–π (–∑ —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –ø–∞–∫–µ—Ç—ñ–≤) - —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ"
echo "2) –ü–æ–≤–Ω–∏–π (–∫–æ–º–ø—ñ–ª—è—Ü—ñ—è –∑ –∏—Å—Ö–æ–¥–Ω–∏–∫—ñ–≤) - –¥–ª—è –¥–æ—Å–≤—ñ–¥—á–µ–Ω–∏—Ö"
read -p "–í–∞—à –≤–∏–±—ñ—Ä [1/2]: " VIM_CHOICE

case $VIM_CHOICE in
    1)
        # –®–≤–∏–¥–∫–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ –ø–∞–∫–µ—Ç—ñ–≤
        step "–í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ Vim –∑ —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –ø–∞–∫–µ—Ç—ñ–≤..."
        sudo apt install -y vim-gtk3 neovim

        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ clipboard
        if vim --version | grep -q "+clipboard"; then
            success "Vim –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é clipboard"
        else
            warning "Vim –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –∞–ª–µ clipboard –º–æ–∂–µ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏"
        fi
        ;;
    2)
        # –ü–æ–≤–Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ –∏—Å—Ö–æ–¥–Ω–∏–∫—ñ–≤
        step "–ö–æ–º–ø—ñ–ª—é—î–º–æ Vim –∑ –∏—Å—Ö–æ–¥–Ω–∏–∫—ñ–≤..."

        # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∏–º—á–∞—Å–æ–≤–æ—ó –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó
        BUILD_DIR="/tmp/vim_build"
        mkdir -p "$BUILD_DIR"
        cd "$BUILD_DIR"

        # –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ —Ä–æ–∑–ø–∞–∫—É–≤–∞–Ω–Ω—è Vim
        if [ ! -d "vim" ]; then
            git clone https://github.com/vim/vim.git
        fi

        cd vim
        git pull
        git checkout master

        # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —Ç–∞ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—è
        step "–ö–æ–Ω—Ñ—ñ–≥—É—Ä—É—î–º–æ Vim..."
        ./configure \
            --with-features=huge \
            --enable-multibyte \
            --enable-rubyinterp=yes \
            --enable-python3interp=yes \
            --enable-perlinterp=yes \
            --enable-luainterp=yes \
            --enable-gui=gtk3 \
            --enable-cscope \
            --prefix=/usr/local \
            --with-x \
            --enable-clipboard \
            --with-xterm_clipboard

        step "–ö–æ–º–ø—ñ–ª—é—î–º–æ Vim..."
        make -j$(nproc)

        step "–í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ Vim..."
        sudo make install

        # –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ —Ä–æ–±–æ—á–æ—ó –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó
        cd -

        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
        if vim --version | grep -q "+clipboard"; then
            success "Vim —É—Å–ø—ñ—à–Ω–æ —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω–æ –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é clipboard"
        else
            error "–ü—Ä–æ–±–ª–µ–º–∞ –∑ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—î—é Vim"
            exit 1
        fi
        ;;
    *)
        error "–ù–µ–≤—ñ—Ä–Ω–∏–π –≤–∏–±—ñ—Ä"
        exit 1
        ;;
esac

# ==============================================================================
# –ö–†–û–ö 3: –°–¢–í–û–†–ï–ù–ù–Ø –í–Ü–†–¢–£–ê–õ–¨–ù–û–ì–û –°–ï–†–ï–î–û–í–ò–©–ê PYTHON
# ==============================================================================
step "–°—Ç–≤–æ—Ä—é—î–º–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ Python..."

read -p "–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –¥–ª—è venv [.venv]: " VENV_DIR
VENV_DIR=${VENV_DIR:-.venv}
VENV_PATH="$HOME/$VENV_DIR"

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è venv
if [ -d "$VENV_PATH" ]; then
    warning "–î–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è $VENV_PATH –≤–∂–µ —ñ—Å–Ω—É—î"
    read -p "–ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏? [y/N]: " RECREATE
    if [[ $RECREATE =~ ^[Yy]$ ]]; then
        rm -rf "$VENV_PATH"
        python3 -m venv "$VENV_PATH"
        success "–í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –ø–µ—Ä–µ—Å—Ç–≤–æ—Ä–µ–Ω–æ"
    else
        info "–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ñ—Å–Ω—É—é—á–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ"
    fi
else
    python3 -m venv "$VENV_PATH"
    success "–í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ —É $VENV_PATH"
fi

# ==============================================================================
# –ö–†–û–ö 4: –í–°–¢–ê–ù–û–í–õ–ï–ù–ù–Ø PYTHON-–ë–Ü–ë–õ–Ü–û–¢–ï–ö
# ==============================================================================
step "–í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ Python-–±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏..."

# –ê–∫—Ç–∏–≤—É—î–º–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ
source "$VENV_PATH/bin/activate"

# –û–Ω–æ–≤–ª—é—î–º–æ pip
pip install --upgrade pip

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫ –∑ —Ñ–∞–π–ª—É –∞–±–æ –±–∞–∑–æ–≤–æ–≥–æ –Ω–∞–±–æ—Ä—É
if [ -f "requirements.txt" ]; then
    pip install -r requirements.txt
    success "–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –∑ requirements.txt –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
elif [ -f "piplist.txt" ]; then
    pip install -r piplist.txt
    success "–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –∑ piplist.txt –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
else
    # –ë–∞–∑–æ–≤–∏–π –Ω–∞–±—ñ—Ä –¥–ª—è —Ä–æ–∑—Ä–æ–±–∫–∏
    pip install \
        black \
        flake8 \
        isort \
        pylint \
        mypy \
        pytest \
        numpy \
        pandas \
        requests \
        jupyter
    success "–ë–∞–∑–æ–≤—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –¥–ª—è —Ä–æ–∑—Ä–æ–±–∫–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
fi

# –î–µ–∞–∫—Ç–∏–≤—É—î–º–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ
deactivate

# ==============================================================================
# –ö–†–û–ö 5: –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø VIM
# ==============================================================================
step "–ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ Vim..."

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è vim-plug
if [ ! -f "$HOME/.vim/autoload/plug.vim" ]; then
    curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    success "vim-plug –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
else
    info "vim-plug –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π"
fi

# –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è .vimrc –∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ—é –∫–æ–ø—ñ—î—é
if [ -f "vimrc" ]; then
    if [ -f "$HOME/.vimrc" ]; then
        cp "$HOME/.vimrc" "$HOME/.vimrc.backup.$(date +%Y%m%d_%H%M%S)"
        info "–ó—Ä–æ–±–ª–µ–Ω–æ —Ä–µ–∑–µ—Ä–≤–Ω—É –∫–æ–ø—ñ—é —ñ—Å–Ω—É—é—á–æ–≥–æ .vimrc"
    fi

    cp "vimrc" "$HOME/.vimrc"
    success ".vimrc —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ"
else
    warning "–§–∞–π–ª vimrc –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –ø–æ—Ç–æ—á–Ω—ñ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó"

    # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–∞–∑–æ–≤–æ–≥–æ .vimrc
    cat > "$HOME/.vimrc" << 'EOF'
" –ë–∞–∑–æ–≤–∏–π .vimrc
set nocompatible
filetype off

set number
set relativenumber
syntax on
set encoding=utf-8
set tabstop=4
set shiftwidth=4
set expandtab
set mouse=a

call plug#begin('~/.vim/plugged')
Plug 'preservim/nerdtree'
Plug 'junegunn/fzf'
Plug 'junegunn/fzf.vim'
call plug#end()

nnoremap <C-n> :NERDTreeToggle<CR>
EOF

    success "–°—Ç–≤–æ—Ä–µ–Ω–æ –±–∞–∑–æ–≤–∏–π .vimrc"
fi

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–ª–∞–≥—ñ–Ω—ñ–≤
step "–í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–ª–∞–≥—ñ–Ω–∏ Vim..."
vim +PlugInstall +qall

# ==============================================================================
# –ö–†–û–ö 6: –î–û–î–ê–¢–ö–û–í–Ü –Ü–ù–°–¢–†–£–ú–ï–ù–¢–ò
# ==============================================================================
step "–í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã..."

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è LSP-—Å–µ—Ä–≤–µ—Ä—ñ–≤
info "–í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ LSP-—Å–µ—Ä–≤–µ—Ä–∏..."

# Python LSP
sudo apt install -y nodejs npm
sudo npm install -g pyright

# –Ü–Ω—à—ñ LSP-—Å–µ—Ä–≤–µ—Ä–∏
sudo npm install -g \
    typescript \
    typescript-language-server \
    vscode-langservers-extracted \
    prettier \
    eslint

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è fzf
if ! command -v fzf &> /dev/null; then
    git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
    ~/.fzf/install --all
fi

# ==============================================================================
# –ö–†–û–ö 7: –§–Ü–ù–ê–õ–¨–ù–Ü –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø
# ==============================================================================
step "–§—ñ–Ω–∞–ª—å–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è..."

# –î–æ–¥–∞–≤–∞–Ω–Ω—è —à–ª—è—Ö—É –¥–æ venv –≤ .bashrc
if ! grep -q "$VENV_PATH/bin" "$HOME/.bashrc"; then
    echo "" >> "$HOME/.bashrc"
    echo "# Python virtual environment" >> "$HOME/.bashrc"
    echo "export PATH=\"$VENV_PATH/bin:\$PATH\"" >> "$HOME/.bashrc"
    success "–®–ª—è—Ö –¥–æ venv –¥–æ–¥–∞–Ω–æ –≤ .bashrc"
fi

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –¥–ª—è undo —Ñ–∞–π–ª—ñ–≤
mkdir -p ~/.vim/undodir

# ==============================================================================
# –ó–ê–í–ï–†–®–ï–ù–ù–Ø
# ==============================================================================
echo ""
echo "================================================================"
success "–Ü–ù–°–¢–ê–õ–Ø–¶–Ü–Æ –ó–ê–í–ï–†–®–ï–ù–û!"
echo "================================================================"
echo ""
echo "üìã –©–û –ë–£–õ–û –ó–†–û–ë–õ–ï–ù–û:"
echo "   ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ —Å–∏—Å—Ç–µ–º—É —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –±–∞–∑–æ–≤—ñ –ø–∞–∫–µ—Ç–∏"
echo "   ‚úÖ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ Vim –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é clipboard"
echo "   ‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ: $VENV_PATH"
echo "   ‚úÖ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ Python-–±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏"
echo "   ‚úÖ –ù–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ .vimrc —Ç–∞ –ø–ª–∞–≥—ñ–Ω–∏"
echo "   ‚úÖ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ LSP-—Å–µ—Ä–≤–µ—Ä–∏"
echo ""
echo "üéØ –ù–ê–°–¢–£–ü–ù–Ü –ö–†–û–ö–ò:"
echo "   1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å —Ç–µ—Ä–º—ñ–Ω–∞–ª: source ~/.bashrc"
echo "   2. –ê–∫—Ç–∏–≤—É–π—Ç–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ: source $VENV_PATH/bin/activate"
echo "   3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Vim: vim --version | grep clipboard"
echo "   4. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–ª–∞–≥—ñ–Ω–∏: vim +PlugStatus"
echo ""
echo "üîß –î–û–î–ê–¢–ö–û–í–Ü –ö–û–ú–ê–ù–î–ò:"
echo "   - –ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ: source $VENV_PATH/bin/activate"
echo "   - –î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ: deactivate"
echo "   - –û–Ω–æ–≤–∏—Ç–∏ –ø–ª–∞–≥—ñ–Ω–∏ Vim: vim +PlugUpdate"
echo "   - –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ LSP: vim +CocList services"
echo ""
echo "================================================================"

# –§—ñ–Ω–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
if command -v vim &> /dev/null && vim --version | grep -q "+clipboard"; then
    success "Vim –≥–æ—Ç–æ–≤–∏–π –¥–æ —Ä–æ–±–æ—Ç–∏ –∑ –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é clipboard!"
else
    warning "Vim –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –∞–ª–µ clipboard –º–æ–∂–µ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏"
fi
